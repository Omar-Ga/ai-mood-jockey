{% extends 'web_interface/base.html' %}

{% block content %}
<div class="container mx-auto px-6 pt-12">
    <!-- Header -->
    <div class="max-w-3xl mb-16">
        <h1 class="text-5xl md:text-7xl font-bold mb-6">
            Design your <span class="text-gradient">Atmosphere.</span>
        </h1>
        <p class="text-lg text-dim leading-relaxed">
            Speak your current orbit into existence. AI interprets the spectral depth of your thoughts to curate the
            perfect sonic backdrop.
        </p>
    </div>

    <!-- Interface Console -->
    <div class="max-w-4xl mb-24">
        <div class="glass p-2 rounded-2xl flex flex-col md:flex-row gap-2 border-white/10 shadow-2xl">
            <input type="text" id="moodInput" placeholder="E.g., 'Late night focus in a rain-slicked city...'"
                class="flex-grow bg-transparent px-6 py-4 outline-none text-lg text-white placeholder-dim/50 font-medium"
                autocomplete="off">
            <button id="searchBtn"
                class="btn-primary px-10 py-4 rounded-xl flex items-center justify-center gap-3 group transition-all">
                <span>Synthesize</span>
                <svg viewBox="0 0 24 24" class="w-4 h-4 fill-current group-hover:translate-x-1 transition-transform">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Enhanced Loading State -->
    <div id="loadingIndicator" class="hidden my-32 text-center">
        <div class="flex justify-center gap-4 mb-8">
            <div class="w-1 h-12 bg-white animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-1 h-12 bg-white animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-1 h-12 bg-white animate-bounce" style="animation-delay: 0.3s"></div>
        </div>
        <p class="text-xs font-bold uppercase tracking-[0.4em] text-white/40">Analyzing semantic patterns</p>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" class="hidden mb-32">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 mb-12 border-b border-white/5 pb-8">
            <div>
                <h2 class="text-3xl font-bold">Sonic Manifestation</h2>
            </div>
            <div id="aiKeywords" class="flex gap-2 flex-wrap justify-end">
                <!-- Tags injected here -->
            </div>
        </div>

        <div id="trackList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Tracks injected here -->
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="flex justify-center items-center gap-8 mt-16 hidden">
            <button id="prevBtn"
                class="btn-secondary px-6 py-2 rounded-lg text-xs font-bold transition-all disabled:opacity-20 disabled:cursor-not-allowed">Previous</button>
            <span id="pageInfo" class="text-xs font-bold uppercase tracking-widest text-dim">Page 1 of 1</span>
            <button id="nextBtn"
                class="btn-secondary px-6 py-2 rounded-lg text-xs font-bold transition-all disabled:opacity-20 disabled:cursor-not-allowed">Next</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchBtn = document.getElementById('searchBtn');
        const moodInput = document.getElementById('moodInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsArea = document.getElementById('resultsArea');
        const trackList = document.getElementById('trackList');
        const aiKeywords = document.getElementById('aiKeywords');
        const paginationControls = document.getElementById('paginationControls');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');

        let currentlyPlaying = null;
        let allTracks = [];
        let currentPage = 1;
        const tracksPerPage = 6;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const handleSearch = async () => {
            const userInput = moodInput.value.trim();
            if (!userInput) return;

            loadingIndicator.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            searchBtn.disabled = true;
            searchBtn.classList.add('opacity-50');

            if (window.closePlayer) {
                window.closePlayer();
            }

            try {
                const response = await fetch('/generate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ user_input: userInput })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Request failed');

                allTracks = data.tracks;
                currentPage = 1;
                renderResults(data);

            } catch (error) {
                console.error(error);
            } finally {
                loadingIndicator.classList.add('hidden');
                searchBtn.disabled = false;
                searchBtn.classList.remove('opacity-50');
            }
        };

        const renderResults = (data) => {
            aiKeywords.innerHTML = '';
            const addTag = (txt) => {
                const span = document.createElement('span');
                span.className = `px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-white/5 border border-white/10 text-dim`;
                span.textContent = txt;
                aiKeywords.appendChild(span);
            };

            const k = data.keywords || {};
            if (k.genres) k.genres.forEach(g => addTag(g));
            if (k.moods) k.moods.forEach(m => addTag(m));
            if (k.keywords) k.keywords.forEach(kw => addTag(kw));

            renderPage();
            resultsArea.classList.remove('hidden');
        };

        const renderPage = () => {
            const start = (currentPage - 1) * tracksPerPage;
            const end = start + tracksPerPage;
            const displayedTracks = allTracks.slice(start, end);
            const totalPages = Math.ceil(allTracks.length / tracksPerPage);

            trackList.innerHTML = '';
            displayedTracks.forEach((track) => {
                const card = document.createElement('div');
                card.className = "group relative cursor-pointer fade-in";
                
                // Safe DOM manipulation to prevent XSS
                card.innerHTML = `
                    <div class="aspect-square rounded-2xl overflow-hidden bg-white/5 border border-white/10 mb-4 relative">
                        <div class="img-container w-full h-full"></div>
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/40 backdrop-blur-sm">
                            <button class="play-btn w-12 h-12 bg-white text-black rounded-full flex items-center justify-center shadow-xl hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 fill-current ml-1" viewBox="0 0 20 20"><path d="M4.5 2.691a1 1 0 011.555-.832l10 6.618a1 1 0 010 1.664l-10 6.618A1 1 0 014.5 15.118V2.691z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h4 class="track-title font-bold text-sm truncate mb-1"></h4>
                        <p class="track-artist text-xs text-dim truncate"></p>
                    </div>
                `;
                
                const imgContainer = card.querySelector('.img-container');
                if (track.album_image) {
                    const img = document.createElement('img');
                    img.src = track.album_image;
                    img.className = "w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 group-hover:scale-105";
                    imgContainer.appendChild(img);
                } else {
                    imgContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center opacity-20"><svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5s2.01-4.5 4.5-4.5 4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg></div>`;
                }

                const playBtn = card.querySelector('.play-btn');
                playBtn.dataset.url = track.preview_url;
                playBtn.dataset.title = track.title;
                playBtn.dataset.artist = track.artist;
                playBtn.dataset.image = track.album_image || '';

                card.querySelector('.track-title').textContent = track.title;
                card.querySelector('.track-artist').textContent = track.artist;

                trackList.appendChild(card);
            });

            // Update Pagination UI
            if (allTracks.length > tracksPerPage) {
                paginationControls.classList.remove('hidden');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            } else {
                paginationControls.classList.add('hidden');
            }

            setupAudio();
        };

        const setupAudio = () => {
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.onclick = function (e) {
                    e.stopPropagation();
                    const url = this.dataset.url;
                    const title = this.dataset.title;
                    const artist = this.dataset.artist;
                    const image = this.dataset.image;
                    
                    if (window.playTrack) {
                        window.playTrack(url, title, artist, image);
                    }
                };
            });
        };

        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            }
        });

        nextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(allTracks.length / tracksPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            }
        });

        searchBtn.addEventListener('click', handleSearch);
        moodInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });
    });
</script>
{% endblock %}